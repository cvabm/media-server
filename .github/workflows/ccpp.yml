name: C/C++ CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: media-server

      - name: Sdk
        uses: actions/checkout@v2
        with:
          repository: ireader/sdk
          path: sdk
          
      - name: avcodec
        uses: actions/checkout@v2
        with:
          repository: ireader/avcodec
          path: avcodec

      - name: Make
        run: make
        working-directory: media-server

      - name: Build static + shared library
        run: |
          cd media-server/libmpeg
          make clean
          make -j$(nproc)           # 先编译静态库（默认）
          make shared=1 -j$(nproc)  # 再强制编译动态库

      - name: List all generated libraries
        run: |
          echo "=== 最终生成的库文件 ==="
          find media-server/libmpeg -name "libmpeg.*" | sort
          echo ""
          echo "详细大小："
          ls -lh media-server/libmpeg/debug.ubuntu24.04-linux64/libmpeg.*
          
          # 可选：上传方便下载
          mkdir -p artifacts
          cp media-server/libmpeg/debug.ubuntu24.04-linux64/libmpeg.* artifacts/ || true

      - name: Upload libraries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: libmpeg-libraries
          path: artifacts/
          
      - name: List generated files（推荐方式）
        run: |
          echo "=== 当前工作目录结构 ==="
          pwd
          ls -R
          
          echo "=== 只看 libmpeg 目录下的所有文件（包含子目录）==="
          find media-server/libmpeg -type f -print | sort
          
          echo "=== 只看编译生成的 .a/.so/.o 文件 ==="
          find media-server -name "*.a" -o -name "*.so" -o -name "*.o" | sort
        working-directory: .
