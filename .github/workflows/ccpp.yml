name: C/C++ CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: media-server

      - name: Sdk
        uses: actions/checkout@v2
        with:
          repository: ireader/sdk
          path: sdk
          
      - name: avcodec
        uses: actions/checkout@v2
        with:
          repository: ireader/avcodec
          path: avcodec

      - name: Make
        run: make
        working-directory: media-server

      - name: Build libmpeg.so
        run: |
          cd media-server/libmpeg
          make clean
          make -j$(nproc)
          make shared=1 -j$(nproc)       # 这一行就生成了 .so
          
      - name: Package both .a and .so
        run: |
          mkdir -p upload/libmpeg
          cp media-server/libmpeg/debug.ubuntu24.04-linux64/libmpeg.* upload/libmpeg/
          cp -r media-server/libmpeg/include upload/libmpeg/
          
      - name: Upload complete package (含 .so)
        uses: actions/upload-artifact@v4
        with:
          name: libmpeg-with-so-ubuntu24
          path: upload/

